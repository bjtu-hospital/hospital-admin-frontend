# 排班管理功能更新说明

## 更新内容

### 1. 医生排班界面样式优化 ✅

**修改文件**: `src/views/schedule/DoctorSchedule.vue`

**变更内容**:
- 月历视图添加外层滚动容器，滚动条位于整个表格下方
- 优化卡片透明度和背景色
  - 普通/专家/特需：从 `bg-*-500/10` 改为 `bg-*-500/20`
  - hover 效果：从 `/20` 改为 `/30`
  - 停诊状态：添加 `opacity-70`
  - 日期格子：从 `bg-card` 改为 `bg-background`
- 图例透明度统一更新

---

### 2. 排班价格设置功能 ✅

**修改文件**: `src/views/schedule/ScheduleDialog.vue`

**新增功能**:
- 添加价格模式选择（默认价格 / 自定义价格）
- 使用默认价格时，显示门诊设定的默认价格（如果有）
- 自定义价格时，可手动输入 1-10000 元
- 提交时：使用默认价格则发送 `price: 0`，后端识别 `<=0` 的值为使用门诊默认价格

**UI 变更**:
```vue
<!-- 新增的价格选项 -->
<div>价格设置</div>
- [x] 使用门诊默认价格
- [ ] 自定义价格
```

---

### 3. 门诊管理增强功能 ✅

**修改文件**: `src/views/schedule/ClinicManagement.vue`

**新增功能**:

#### a. 门诊信息编辑
- 门诊卡片右上角添加编辑按钮（铅笔图标）
- 可修改门诊名称和地址

#### b. 默认价格设置
- 普通/国疗门诊：可设置普通号和专家号默认价格
- 特需门诊：可设置特需号默认价格
- 价格可留空（表示不设置默认值）

**新增对话框**:
```
编辑门诊
├── 基本信息
│   ├── 门诊名称 *
│   └── 门诊地址
└── 默认价格设置
    ├── 普通号默认价格 (普通/国疗)
    ├── 专家号默认价格 (普通/国疗)
    └── 特需号默认价格 (特需)
```

---

## API 接口变更

### 1. 排班创建/更新接口 - 价格字段扩展

**接口路径**: 
- `POST /admin/schedules` (创建)
- `PUT /admin/schedules/{schedule_id}` (更新)

**变更**: `price` 字段支持特殊值
```json
{
  "price": 0  // <=0 表示使用门诊默认价格，>0 表示自定义价格
}
```

**后端处理逻辑**:
```python
if price <= 0:
    # 根据 slot_type 获取门诊默认价格
    price = clinic.default_price_normal  # 或 expert / special
```

**兼容性**: ✅ 完全兼容现有接口，不影响已有功能

---

### 2. 门诊更新接口（新增）

**接口路径**: `PUT /admin/clinics/{clinic_id}`

**请求参数** (所有字段可选):
```json
{
  "name": "心内科门诊",                    // 门诊名称
  "address": "内科楼2楼",                   // 门诊地址
  "default_price_normal": 50,            // 普通号默认价格
  "default_price_expert": 100,           // 专家号默认价格
  "default_price_special": 500           // 特需号默认价格
}
```

**响应格式**:
```json
{
  "code": 0,
  "message": {
    "detail": "门诊信息更新成功"
  }
}
```

**说明**:
- 不提供的字段保持原值不变
- 价格字段可设为 `null` 或不提供（表示不设置默认价格）

---

### 3. 门诊列表接口 - 响应字段扩展

**接口路径**: `GET /admin/clinics?dept_id={dept_id}`

**变更**: 响应中的门诊对象新增字段
```json
{
  "clinics": [
    {
      "clinic_id": 1,
      "name": "心内科门诊",
      "type": 0,
      "address": "内科楼2楼",
      
      // 新增字段（未设置则为null）
      "default_price_normal": 50,
      "default_price_expert": 100,
      "default_price_special": 500
    }
  ]
}
```

**兼容性**: ✅ 新增字段，不影响现有功能

---

## 数据库变更建议

```sql
-- 为门诊表添加默认价格字段
ALTER TABLE clinics 
ADD COLUMN default_price_normal DECIMAL(10,2) DEFAULT NULL COMMENT '普通号默认价格',
ADD COLUMN default_price_expert DECIMAL(10,2) DEFAULT NULL COMMENT '专家号默认价格',
ADD COLUMN default_price_special DECIMAL(10,2) DEFAULT NULL COMMENT '特需号默认价格';
```

---

## 使用流程

### 设置门诊默认价格
1. 进入排班管理页面
2. 选择科室
3. 在门诊管理区域，点击门诊卡片右上角的编辑按钮
4. 在"默认价格设置"区域输入价格（可留空）
5. 点击保存

### 创建排班使用默认价格
1. 选择医生，点击"新增排班"
2. 选择门诊和类型
3. 在"价格设置"中选择"使用门诊默认价格"
4. 系统会显示该门诊对应类型的默认价格（如果已设置）
5. 提交后，后端会自动使用门诊默认价格

### 创建排班使用自定义价格
1. 在"价格设置"中选择"自定义价格"
2. 手动输入价格（1-10000 元）
3. 提交

---

## 测试要点

### 前端测试
- [ ] 月历视图滚动条是否在底层
- [ ] 卡片透明度和颜色是否正常
- [ ] 编辑门诊按钮是否可见
- [ ] 门诊编辑对话框能否正常打开/关闭
- [ ] 默认价格设置能否保存
- [ ] 排班对话框价格模式切换是否正常
- [ ] 使用默认价格时是否正确显示
- [ ] 自定义价格输入是否正常

### 后端测试
- [ ] 门诊更新接口是否正常工作
- [ ] 门诊列表返回的默认价格字段是否正确
- [ ] 排班创建时 price=0 是否正确使用默认价格
- [ ] 排班更新时 price>0 是否正确使用自定义价格

---

## 回滚方案

如果需要回滚：
1. 前端：恢复之前的组件版本
2. 后端：新增字段可保留（不影响现有功能），接口可保持兼容
3. 数据库：默认价格字段可保留（nullable，不影响现有数据）

---

## 详细接口文档

完整的接口规范请查看：`src/views/schedule/API接口变更说明.md`
